const twilio = require('twilio')
const { PrismaClient } = require('@prisma/client')

const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

const getSMSSettings = async () => {
  try {
    const settings = await prisma.systemSetting.findMany({
      where: {
        key: {
          in: ['SMS_ENABLED', 'SMS_API_KEY', 'SMS_API_SECRET', 'SMS_FROM_NUMBER', 'SMS_PROVIDER']
        }
      }
    })

    const config = {}
    settings.forEach(setting => {
      config[setting.key.toLowerCase()] = setting.value
    })

    return {
      enabled: config.sms_enabled === 'true',
      apiKey: config.sms_api_key,
      apiSecret: config.sms_api_secret,
      fromNumber: config.sms_from_number,
      provider: config.sms_provider || 'twilio'
    }
  } catch (error) {
    log.error('Error getting SMS settings:', error, { error: error.message, stack: error.stack })
    return {
      enabled: false,
      apiKey: '',
      apiSecret: '',
      fromNumber: '',
      provider: 'twilio'
    }
  }
}

const getSMSConfig = async (req, res) => {
  const log = createRequestLogger(req, 'sms')
  try {
    const settings = await getSMSSettings()
    res.json(settings)
  } catch (error) {
    log.error('Get SMS config error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const updateSMSConfig = async (req, res) => {
  const log = createRequestLogger(req, 'sms')
  try {
    const { enabled, apiKey, apiSecret, fromNumber, provider } = req.body
    
    // Update or create SMS settings
    const settings = [
      { key: 'SMS_ENABLED', value: enabled ? 'true' : 'false', category: 'sms', description: 'Enable SMS notifications' },
      { key: 'SMS_API_KEY', value: apiKey || '', category: 'sms', description: 'SMS API Key' },
      { key: 'SMS_API_SECRET', value: apiSecret || '', category: 'sms', description: 'SMS API Secret' },
      { key: 'SMS_FROM_NUMBER', value: fromNumber || '', category: 'sms', description: 'SMS From Number' },
      { key: 'SMS_PROVIDER', value: provider || 'twilio', category: 'sms', description: 'SMS Provider' }
    ]
    
    for (const setting of settings) {
      await prisma.systemSetting.upsert({
        where: { key: setting.key },
        update: {
          value: setting.value,
          updatedAt: new Date(),
          updatedBy: req.user?.id
        },
        create: {
          key: setting.key,
          value: setting.value,
          category: setting.category,
          description: setting.description,
          updatedBy: req.user?.id
        }
      })
    }
    
    res.json({ message: 'SMS settings updated successfully' })
  } catch (error) {
    log.error('Update SMS config error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const sendSMS = async (req, res) => {
  const log = createRequestLogger(req, 'sms')
  try {
    const { to, message } = req.body

    if (!to || !message) {
      return res.status(400).json({ error: 'Phone number and message are required' })
    }

    const settings = await getSMSSettings()

    if (!settings.enabled) {
      return res.status(400).json({ error: 'SMS notifications are disabled' })
    }

    if (!settings.apiKey || !settings.apiSecret || !settings.fromNumber) {
      return res.status(400).json({ error: 'SMS configuration is incomplete' })
    }

    let client
    if (settings.provider === 'twilio') {
      client = twilio(settings.apiKey, settings.apiSecret)
    } else {
      return res.status(400).json({ error: 'Unsupported SMS provider' })
    }

    const result = await client.messages.create({
      body: message,
      to: to,
      from: settings.fromNumber
    })

    // Log the SMS send
    await prisma.activityLog.create({
      data: {
        userId: req.user?.id,
        userName: req.user?.name,
        userRole: req.user?.role,
        action: 'SEND_SMS',
        resourceType: 'SMS',
        details: `SMS sent to ${to}: ${message.substring(0, 50)}...`,
        ipAddress: req.ip,
        userAgent: req.get('User-Agent')
      }
    })

    res.json({ 
      success: true, 
      message: 'SMS sent successfully',
      messageId: result.sid 
    })
  } catch (error) {
    log.error('Send SMS error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Failed to send SMS' })
  }
}

const sendBulkSMS = async (req, res) => {
  const log = createRequestLogger(req, 'sms')
  try {
    const { recipients, message } = req.body

    if (!recipients || !Array.isArray(recipients) || recipients.length === 0) {
      return res.status(400).json({ error: 'Recipients array is required' })
    }

    if (!message) {
      return res.status(400).json({ error: 'Message is required' })
    }

    const settings = await getSMSSettings()

    if (!settings.enabled) {
      return res.status(400).json({ error: 'SMS notifications are disabled' })
    }

    const results = []
    const errors = []

    for (const recipient of recipients) {
      try {
        let client
        if (settings.provider === 'twilio') {
          client = twilio(settings.apiKey, settings.apiSecret)
        }

        const result = await client.messages.create({
          body: message,
          to: recipient.phone,
          from: settings.fromNumber
        })

        results.push({
          phone: recipient.phone,
          name: recipient.name,
          messageId: result.sid,
          status: 'sent'
        })
      } catch (error) {
        errors.push({
          phone: recipient.phone,
          name: recipient.name,
          error: error.message
        })
      }
    }

    // Log the bulk SMS send
    await prisma.activityLog.create({
      data: {
        userId: req.user?.id,
        userName: req.user?.name,
        userRole: req.user?.role,
        action: 'SEND_BULK_SMS',
        resourceType: 'SMS',
        details: `Bulk SMS sent to ${recipients.length} recipients: ${message.substring(0, 50)}...`,
        ipAddress: req.ip,
        userAgent: req.get('User-Agent')
      }
    })

    res.json({
      success: true,
      message: `SMS sent to ${results.length} recipients`,
      results,
      errors
    })
  } catch (error) {
    log.error('Send bulk SMS error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Failed to send bulk SMS' })
  }
}

const sendNotificationSMS = async (req, res) => {
  const log = createRequestLogger(req, 'sms')
  try {
    const { userId, notificationType, data } = req.body

    if (!userId || !notificationType) {
      return res.status(400).json({ error: 'User ID and notification type are required' })
    }

    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: { contestant: true, judge: true }
    })

    if (!user || !user.smsEnabled || !user.smsPhone) {
      return res.status(400).json({ error: 'User does not have SMS notifications enabled' })
    }

    let message = ''
    switch (notificationType) {
      case 'SCORE_SUBMISSION_REMINDER':
        message = `Reminder: Please submit your scores for ${data.categoryName || 'the category'}`
        break
      case 'CERTIFICATION_REQUEST':
        message = `Certification request: Please review and certify scores for ${data.categoryName || 'the category'}`
        break
      case 'EVENT_UPDATE':
        message = `Event update: ${data.message || 'There has been an update to your event'}`
        break
      case 'CONTEST_SCHEDULE_CHANGE':
        message = `Schedule change: ${data.message || 'Your contest schedule has been updated'}`
        break
      default:
        message = data.message || 'You have a new notification'
    }

    const settings = await getSMSSettings()

    if (!settings.enabled) {
      return res.status(400).json({ error: 'SMS notifications are disabled' })
    }

    let client
    if (settings.provider === 'twilio') {
      client = twilio(settings.apiKey, settings.apiSecret)
    }

    const result = await client.messages.create({
      body: message,
      to: user.smsPhone,
      from: settings.fromNumber
    })

    // Log the notification SMS
    await prisma.activityLog.create({
      data: {
        userId: req.user?.id,
        userName: req.user?.name,
        userRole: req.user?.role,
        action: 'SEND_NOTIFICATION_SMS',
        resourceType: 'SMS',
        details: `Notification SMS sent to ${user.name} (${user.smsPhone}): ${notificationType}`,
        ipAddress: req.ip,
        userAgent: req.get('User-Agent')
      }
    })

    res.json({
      success: true,
      message: 'Notification SMS sent successfully',
      messageId: result.sid
    })
  } catch (error) {
    log.error('Send notification SMS error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Failed to send notification SMS' })
  }
}

const getSMSHistory = async (req, res) => {
  const log = createRequestLogger(req, 'sms')
  try {
    const { page = 1, limit = 50 } = req.query
    const offset = (page - 1) * limit

    const logs = await prisma.activityLog.findMany({
      where: {
        action: {
          in: ['SEND_SMS', 'SEND_BULK_SMS', 'SEND_NOTIFICATION_SMS']
        }
      },
      orderBy: { createdAt: 'desc' },
      skip: offset,
      take: parseInt(limit),
      include: {
        user: {
          select: { name: true, email: true }
        }
      }
    })

    const total = await prisma.activityLog.count({
      where: {
        action: {
          in: ['SEND_SMS', 'SEND_BULK_SMS', 'SEND_NOTIFICATION_SMS']
        }
      }
    })

    res.json({
      logs,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        pages: Math.ceil(total / limit)
      }
    })
  } catch (error) {
    log.error('Get SMS history error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Failed to get SMS history' })
  }
}

module.exports = {
  getSMSConfig,
  updateSMSConfig,
  sendSMS,
  sendBulkSMS,
  sendNotificationSMS,
  getSMSHistory
}

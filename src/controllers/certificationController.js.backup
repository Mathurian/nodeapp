const { PrismaClient } = require('@prisma/client')

const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

const getAllCertifications = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { status, categoryId, contestId, eventId } = req.query
    
    const certifications = await prisma.certification.findMany({
      where: {
        ...(status && { status }),
        ...(categoryId && { categoryId }),
        ...(contestId && { contestId }),
        ...(eventId && { eventId }),
      },
      include: {
        category: {
          select: {
            id: true,
            name: true,
            description: true,
            scoreCap: true,
          }
        },
        contest: {
          select: {
            id: true,
            name: true,
            description: true,
          }
        },
        event: {
          select: {
            id: true,
            name: true,
            startDate: true,
            endDate: true,
          }
        }
      },
      orderBy: [
        { createdAt: 'desc' }
      ]
    })
    
    res.json(certifications)
  } catch (error) {
    log.error('Get certifications error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const createCertification = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { categoryId, contestId, eventId } = req.body
    
    // Check if certification already exists
    const existingCertification = await prisma.certification.findUnique({
      where: {
        categoryId_contestId_eventId: {
          categoryId,
          contestId,
          eventId
        }
      }
    })
    
    if (existingCertification) {
      return res.status(400).json({ error: 'Certification already exists' })
    }
    
    const certification = await prisma.certification.create({
      data: {
        categoryId,
        contestId,
        eventId,
        status: 'PENDING',
        currentStep: 1,
        totalSteps: 4
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.status(201).json(certification)
  } catch (error) {
    log.error('Create certification error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const updateCertification = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    const { status, currentStep, judgeCertified, tallyCertified, auditorCertified, boardApproved, comments } = req.body
    
    const certification = await prisma.certification.update({
      where: { id },
      data: {
        ...(status && { status }),
        ...(currentStep !== undefined && { currentStep }),
        ...(judgeCertified !== undefined && { judgeCertified }),
        ...(tallyCertified !== undefined && { tallyCertified }),
        ...(auditorCertified !== undefined && { auditorCertified }),
        ...(boardApproved !== undefined && { boardApproved }),
        ...(comments !== undefined && { comments }),
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.json(certification)
  } catch (error) {
    log.error('Update certification error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const deleteCertification = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    
    await prisma.certification.delete({
      where: { id }
    })
    
    res.json({ message: 'Certification deleted successfully' })
  } catch (error) {
    log.error('Delete certification error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const getCertificationById = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    
    const certification = await prisma.certification.findUnique({
      where: { id },
      include: {
        category: {
          include: {
            criteria: true,
            contestants: true,
            scores: true
          }
        },
        contest: true,
        event: true
      }
    })
    
    if (!certification) {
      return res.status(404).json({ error: 'Certification not found' })
    }
    
    res.json(certification)
  } catch (error) {
    log.error('Get certification by ID error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const certifyJudge = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    const { comments } = req.body
    
    const certification = await prisma.certification.update({
      where: { id },
      data: {
        judgeCertified: true,
        currentStep: 2,
        comments: comments || ''
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.json(certification)
  } catch (error) {
    log.error('Certify judge error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const certifyTally = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    const { comments } = req.body
    
    const certification = await prisma.certification.update({
      where: { id },
      data: {
        tallyCertified: true,
        currentStep: 3,
        comments: comments || ''
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.json(certification)
  } catch (error) {
    log.error('Certify tally error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const certifyAuditor = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    const { comments } = req.body
    
    const certification = await prisma.certification.update({
      where: { id },
      data: {
        auditorCertified: true,
        currentStep: 4,
        comments: comments || ''
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.json(certification)
  } catch (error) {
    log.error('Certify auditor error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const approveBoard = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    const { comments } = req.body
    
    const certification = await prisma.certification.update({
      where: { id },
      data: {
        boardApproved: true,
        status: 'CERTIFIED',
        certifiedAt: new Date(),
        certifiedBy: req.user.id,
        comments: comments || ''
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.json(certification)
  } catch (error) {
    log.error('Approve board error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const rejectCertification = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const { id } = req.params
    const { rejectionReason } = req.body
    
    const certification = await prisma.certification.update({
      where: { id },
      data: {
        status: 'REJECTED',
        rejectionReason,
        certifiedBy: req.user.id
      },
      include: {
        category: true,
        contest: true,
        event: true
      }
    })
    
    res.json(certification)
  } catch (error) {
    log.error('Reject certification error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const getCertificationStats = async (req, res) => {
  const log = createRequestLogger(req, 'certification')
  try {
    const stats = {
      total: await prisma.certification.count(),
      pending: await prisma.certification.count({ where: { status: 'PENDING' } }),
      inProgress: await prisma.certification.count({ where: { status: 'IN_PROGRESS' } }),
      certified: await prisma.certification.count({ where: { status: 'CERTIFIED' } }),
      rejected: await prisma.certification.count({ where: { status: 'REJECTED' } }),
      judgeCertified: await prisma.certification.count({ where: { judgeCertified: true } }),
      tallyCertified: await prisma.certification.count({ where: { tallyCertified: true } }),
      auditorCertified: await prisma.certification.count({ where: { auditorCertified: true } }),
      boardApproved: await prisma.certification.count({ where: { boardApproved: true } })
    }
    
    res.json(stats)
  } catch (error) {
    log.error('Get certification stats error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

module.exports = {
  getAllCertifications,
  createCertification,
  updateCertification,
  deleteCertification,
  getCertificationById,
  certifyJudge,
  certifyTally,
  certifyAuditor,
  approveBoard,
  rejectCertification,
  getCertificationStats
}

const { PrismaClient } = require('@prisma/client')
const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

/**
 * Get final certification status for a category
 */
const getFinalCertificationStatus = async (req, res) => {
  const log = createRequestLogger(req, 'auditorCertification')
  try {
    const { categoryId } = req.params

    // Get all tally master certifications for this category
    const tallyCertifications = await prisma.categoryCertification.findMany({
      where: {
        categoryId,
        role: 'TALLY_MASTER'
      },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            email: true
          }
        }
      }
    })

    // Get auditor certification status
    const auditorCertification = await prisma.categoryCertification.findFirst({
      where: {
        categoryId,
        role: 'AUDITOR'
      },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            email: true
          }
        }
      }
    })

    // Calculate requirements
    const category = await prisma.category.findUnique({
      where: { id: categoryId },
      select: {
        id: true,
        name: true,
        description: true,
        scoreCap: true,
        contestId: true,
        contest: {
          select: {
            id: true,
            name: true,
            description: true,
            eventId: true,
            event: {
              select: {
                id: true,
                name: true,
                description: true
              }
            }
          }
        }
      }
    })

    // Get all judges assigned to this category
    const categoryJudges = await prisma.categoryJudge.findMany({
      where: { categoryId },
      include: {
        judge: true
      }
    })

    const requiredTallyCertifications = categoryJudges.length
    const completedTallyCertifications = tallyCertifications.length

    // Pre-certification checks
    const canCertify = completedTallyCertifications >= requiredTallyCertifications
    const alreadyCertified = !!auditorCertification

    // Additional checks: verify all scores are certified by their respective judges
    const allScores = await prisma.score.findMany({
      where: { categoryId },
      include: {
        judge: true,
        criterion: true
      }
    })

    const uncertifiedScores = allScores.filter(
      score => !score.isCertified && score.criterionId // Only criterion-level scores
    )
    const hasUncertifiedScores = uncertifiedScores.length > 0

    // Check if all required scores are certified
    const scoresCompleted = !hasUncertifiedScores

    const readyForFinalCertification = canCertify && scoresCompleted && !alreadyCertified

    res.json({
      success: true,
      categoryId,
      categoryName: category?.name,
      canCertify,
      readyForFinalCertification,
      alreadyCertified,
      tallyCertifications: {
        required: requiredTallyCertifications,
        completed: completedTallyCertifications,
        missing: Math.max(0, requiredTallyCertifications - completedTallyCertifications),
        certifications: tallyCertifications
      },
      scoreStatus: {
        total: allScores.length,
        uncertified: uncertifiedScores.length,
        completed: scoresCompleted
      },
      auditorCertified: alreadyCertified,
      auditorCertification: auditorCertification ? {
        certifiedAt: auditorCertification.certifiedAt,
        certifiedBy: auditorCertification.user
      } : null
    })
  } catch (error) {
    log.error('Get final certification status error', {
      error: error.message,
      stack: error.stack,
      categoryId: req.params?.categoryId
    })
    res.status(500).json({ 
      error: 'Failed to get final certification status',
      message: error.message 
    })
  }
}

/**
 * Submit final auditor certification
 */
const submitFinalCertification = async (req, res) => {
  const log = createRequestLogger(req, 'auditorCertification')
  try {
    const { categoryId } = req.params
    const { confirmation1, confirmation2 } = req.body

    // Validate confirmations
    if (!confirmation1 || !confirmation2) {
      return res.status(400).json({ 
        error: 'Both confirmations are required' 
      })
    }

    // Get certification status
    const status = await getFinalCertificationStatusInternal(categoryId)

    if (status.alreadyCertified) {
      return res.status(400).json({ 
        error: 'Final certification has already been completed for this category' 
      })
    }

    if (!status.canCertify) {
      return res.status(400).json({ 
        error: 'Not all required certifications are complete' 
      })
    }

    if (!status.scoresCompleted) {
      return res.status(400).json({ 
        error: 'Not all scores have been certified yet' 
      })
    }

    // Check if auditor is authorized
    const auditor = await prisma.user.findUnique({
      where: { id: req.user.id }
    })

    if (auditor.role !== 'AUDITOR') {
      return res.status(403).json({ 
        error: 'Only AUDITOR role can submit final certification' 
      })
    }

    // Create auditor certification
    const certification = await prisma.categoryCertification.create({
      data: {
        categoryId,
        role: 'AUDITOR',
        userId: req.user.id
      }
    })

    // Lock all scores in this category permanently
    await prisma.score.updateMany({
      where: { 
        categoryId,
        isCertified: false // Only lock uncertified scores
      },
      data: { 
        isLocked: true,
        isCertified: true // Mark as certified
      }
    })

    res.json({
      success: true,
      message: 'Final certification completed successfully. All scores are now permanently locked.',
      certification
    })
  } catch (error) {
    log.error('Submit final certification error', {
      error: error.message,
      stack: error.stack,
      categoryId: req.params?.categoryId,
      userId: req.user?.id
    })
    res.status(500).json({ 
      error: 'Failed to submit final certification',
      message: error.message 
    })
  }
}

/**
 * Internal helper to get certification status
 */
async function getFinalCertificationStatusInternal(categoryId) {
  const tallyCertifications = await prisma.categoryCertification.findMany({
    where: {
      categoryId,
      role: 'TALLY_MASTER'
    }
  })

  const auditorCertification = await prisma.categoryCertification.findFirst({
    where: {
      categoryId,
      role: 'AUDITOR'
    }
  })

  const categoryJudges = await prisma.categoryJudge.findMany({
    where: { categoryId }
  })

  const allScores = await prisma.score.findMany({
    where: { categoryId }
  })

  const uncertifiedScores = allScores.filter(s => !s.isCertified && s.criterionId)
  const requiredTallyCertifications = categoryJudges.length
  const completedTallyCertifications = tallyCertifications.length

  return {
    canCertify: completedTallyCertifications >= requiredTallyCertifications,
    alreadyCertified: !!auditorCertification,
    scoresCompleted: uncertifiedScores.length === 0
  }
}

module.exports = {
  getFinalCertificationStatus,
  submitFinalCertification
}


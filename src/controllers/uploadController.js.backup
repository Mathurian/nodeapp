const fs = require('fs')
const path = require('path')
const { PrismaClient } = require('@prisma/client')

const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

const uploadFile = async (req, res) => {
  const log = createRequestLogger(req, 'upload')
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'No file uploaded' })
    }

    const file = {
      filename: req.file.filename,
      originalName: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size,
      path: req.file.path,
      uploadedBy: req.user.id
    }

    res.json({ message: 'File uploaded successfully', file })
  } catch (error) {
    log.error('Upload file error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const uploadImage = async (req, res) => {
  const log = createRequestLogger(req, 'upload')
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'No image uploaded' })
    }

    const image = {
      filename: req.file.filename,
      originalName: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size,
      path: req.file.path,
      uploadedBy: req.user.id
    }

    res.json({ message: 'Image uploaded successfully', image })
  } catch (error) {
    log.error('Upload image error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const deleteFile = async (req, res) => {
  const log = createRequestLogger(req, 'upload')
  try {
    const { fileId } = req.params

    // Find the file record
    const file = await prisma.file.findUnique({
      where: { id: fileId }
    })

    if (!file) {
      return res.status(404).json({ error: 'File not found' })
    }

    // Delete the physical file
    if (fs.existsSync(file.path)) {
      fs.unlinkSync(file.path)
    }

    // Delete the database record
    await prisma.file.delete({
      where: { id: fileId }
    })

    res.json({ message: 'File deleted successfully' })
  } catch (error) {
    log.error('Delete file error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const getFiles = async (req, res) => {
  const log = createRequestLogger(req, 'upload')
  try {
    // List files from the file system instead of database
    const uploadDir = path.join(process.cwd(), 'uploads')
    
    if (!fs.existsSync(uploadDir)) {
      return res.json([])
    }
    
    const files = fs.readdirSync(uploadDir)
    const fileList = files
      .filter(file => !fs.statSync(path.join(uploadDir, file)).isDirectory())
      .map(file => {
        const filePath = path.join(uploadDir, file)
        const stats = fs.statSync(filePath)
        return {
          id: file,
          filename: file,
          filepath: filePath,
          size: stats.size,
          createdAt: stats.birthtime,
          updatedAt: stats.mtime,
          uploadedBy: req.user?.id || 'system'
        }
      })
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))

    res.json(fileList)
  } catch (error) {
    log.error('Get files error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

module.exports = {
  uploadFile,
  uploadImage,
  deleteFile,
  getFiles
}

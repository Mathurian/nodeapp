const { PrismaClient } = require('@prisma/client')
const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

// Get contestant bios
const getContestantBios = async (req, res) => {
  const log = createRequestLogger(req, 'bio')
  try {
    const { eventId, contestId, categoryId } = req.query
    const where = {}

    if (eventId) {
      where.contestContestants = {
        some: {
          contest: {
            eventId
          }
        }
      }
    }

    if (contestId) {
      where.contestContestants = {
        some: {
          contestId
        }
      }
    }

    if (categoryId) {
      where.categoryContestants = {
        some: {
          categoryId
        }
      }
    }

    const contestants = await prisma.contestant.findMany({
      where,
      select: {
        id: true,
        name: true,
        bio: true,
        imagePath: true,
        gender: true,
        pronouns: true,
        contestantNumber: true,
        contestContestants: {
          select: {
            contest: {
              select: {
                id: true,
                name: true,
                event: {
                  select: {
                    id: true,
                    name: true
                  }
                }
              }
            }
          }
        },
        categoryContestants: {
          select: {
            category: {
              select: {
                id: true,
                name: true
              }
            }
          }
        }
      },
      orderBy: { contestantNumber: 'asc' }
    })

    res.json(contestants)
  } catch (error) {
    log.error('Get contestant bios error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

// Get judge bios
const getJudgeBios = async (req, res) => {
  const log = createRequestLogger(req, 'bio')
  try {
    const { eventId, contestId, categoryId } = req.query
    const where = {}

    if (eventId) {
      where.contestJudges = {
        some: {
          contest: {
            eventId
          }
        }
      }
    }

    if (contestId) {
      where.contestJudges = {
        some: {
          contestId
        }
      }
    }

    if (categoryId) {
      where.categoryJudges = {
        some: {
          categoryId
        }
      }
    }

    const judges = await prisma.judge.findMany({
      where,
      select: {
        id: true,
        name: true,
        bio: true,
        imagePath: true,
        gender: true,
        pronouns: true,
        isHeadJudge: true,
        contestJudges: {
          select: {
            contest: {
              select: {
                id: true,
                name: true,
                event: {
                  select: {
                    id: true,
                    name: true
                  }
                }
              }
            }
          }
        },
        categoryJudges: {
          select: {
            category: {
              select: {
                id: true,
                name: true
              }
            }
          }
        }
      },
      orderBy: { name: 'asc' }
    })

    res.json(judges)
  } catch (error) {
    log.error('Get judge bios error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

// Update contestant bio and image
const updateContestantBio = async (req, res) => {
  const log = createRequestLogger(req, 'bio')
  try {
    const { contestantId } = req.params
    const { bio } = req.body
    let imagePath = req.body.imagePath || null

    // Handle file upload if present
    if (req.file) {
      imagePath = `/uploads/bios/${req.file.filename}`
    }

    const data = {}
    if (bio !== undefined) data.bio = bio
    if (imagePath !== undefined) data.imagePath = imagePath

    const contestant = await prisma.contestant.update({
      where: { id: contestantId },
      data,
      select: {
        id: true,
        name: true,
        bio: true,
        imagePath: true
      }
    })

    res.json(contestant)
  } catch (error) {
    log.error('Update contestant bio error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

// Update judge bio and image
const updateJudgeBio = async (req, res) => {
  const log = createRequestLogger(req, 'bio')
  try {
    const { judgeId } = req.params
    const { bio } = req.body
    let imagePath = req.body.imagePath || null

    // Handle file upload if present
    if (req.file) {
      imagePath = `/uploads/bios/${req.file.filename}`
    }

    const data = {}
    if (bio !== undefined) data.bio = bio
    if (imagePath !== undefined) data.imagePath = imagePath

    const judge = await prisma.judge.update({
      where: { id: judgeId },
      data,
      select: {
        id: true,
        name: true,
        bio: true,
        imagePath: true
      }
    })

    res.json(judge)
  } catch (error) {
    log.error('Update judge bio error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

module.exports = {
  getContestantBios,
  getJudgeBios,
  updateContestantBio,
  updateJudgeBio
}


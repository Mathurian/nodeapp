const { PrismaClient } = require('@prisma/client')

const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

const getAllTemplates = async (req, res) => {
  const log = createRequestLogger(req, 'templates')
  try {
    const templates = await prisma.categoryTemplate.findMany({
      include: {
        criteria: true
      },
      orderBy: { createdAt: 'desc' }
    })

    // Add default tags array if not present
    const templatesWithDefaults = templates.map(template => ({
      ...template,
      tags: template.tags || [],
      categoryType: template.categoryType || 'CUSTOM',
      isActive: template.isActive !== undefined ? template.isActive : true,
      usageCount: template.usageCount || 0
    }))

    res.json(templatesWithDefaults)
  } catch (error) {
    log.error('Get all templates error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const getTemplateById = async (req, res) => {
  const log = createRequestLogger(req, 'templates')
  try {
    const { id } = req.params

    const template = await prisma.categoryTemplate.findUnique({
      where: { id },
      include: {
        criteria: true
      }
    })

    if (!template) {
      return res.status(404).json({ error: 'Template not found' })
    }

    res.json(template)
  } catch (error) {
    log.error('Get template error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const createTemplate = async (req, res) => {
  const log = createRequestLogger(req, 'templates')
  try {
    const { name, description, criteria } = req.body

    // Validate required fields
    if (!name) {
      return res.status(400).json({ error: 'Name is required' })
    }

    log.debug('Creating template:', { name, description, criteria })

    // Create template with criteria in transaction
    const template = await prisma.categoryTemplate.create({
      data: {
        name,
        description: description || null,
        criteria: criteria ? {
          create: criteria.map((c) => ({
            name: c.name,
            maxScore: c.maxScore || 10
          }))
        } : undefined
      },
      include: {
        criteria: true
      }
    })

    res.status(201).json(template)
  } catch (error) {
    log.error('Create template error:', error.message, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error', details: error.message })
  }
}

const updateTemplate = async (req, res) => {
  const log = createRequestLogger(req, 'templates')
  try {
    const { id } = req.params
    const { name, description, criteria } = req.body

    // Update template
    const template = await prisma.categoryTemplate.update({
      where: { id },
      data: {
        name,
        description: description || null
      },
      include: {
        criteria: true
      }
    })

    // If criteria are provided, update them
    if (criteria) {
      // Delete old criteria
      await prisma.templateCriterion.deleteMany({
        where: { templateId: id }
      })

      // Create new criteria
      await prisma.templateCriterion.createMany({
        data: criteria.map((c) => ({
          templateId: id,
          name: c.name,
          maxScore: c.maxScore || 10
        }))
      })
    }

    const updatedTemplate = await prisma.categoryTemplate.findUnique({
      where: { id },
      include: {
        criteria: true
      }
    })

    res.json(updatedTemplate)
  } catch (error) {
    log.error('Update template error:', error.message, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error', details: error.message })
  }
}

const deleteTemplate = async (req, res) => {
  const log = createRequestLogger(req, 'templates')
  try {
    const { id } = req.params

    await prisma.categoryTemplate.delete({
      where: { id }
    })

    res.status(204).send()
  } catch (error) {
    log.error('Delete template error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const duplicateTemplate = async (req, res) => {
  const log = createRequestLogger(req, 'templates')
  try {
    const { id } = req.params

    const originalTemplate = await prisma.categoryTemplate.findUnique({
      where: { id },
      include: {
        criteria: true
      }
    })

    if (!originalTemplate) {
      return res.status(404).json({ error: 'Template not found' })
    }

    const duplicatedTemplate = await prisma.categoryTemplate.create({
      data: {
        name: `${originalTemplate.name} (Copy)`,
        description: originalTemplate.description,
        criteria: {
          create: originalTemplate.criteria.map(c => ({
            name: c.name,
            maxScore: c.maxScore
          }))
        }
      },
      include: {
        criteria: true
      }
    })

    res.status(201).json(duplicatedTemplate)
  } catch (error) {
    log.error('Duplicate template error:', error, { error: error.message, stack: error.stack })
    res.status(500).json({ error: 'Internal server error' })
  }
}

module.exports = {
  getAllTemplates,
  getTemplateById,
  createTemplate,
  updateTemplate,
  deleteTemplate,
  duplicateTemplate
}

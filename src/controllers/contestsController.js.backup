const { PrismaClient } = require('@prisma/client')

const prisma = require('../utils/prisma')
const { createRequestLogger } = require('../utils/logger')

const getContestById = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { id } = req.params
    log.debug('Fetching contest by ID', { contestId: id })

    const contest = await prisma.contest.findUnique({
      where: { id },
      include: {
        event: true,
        categories: {
          include: {
            _count: {
              select: {
                criteria: true,
                contestants: true,
                judges: true,
                scores: true
              }
            }
          }
        },
        _count: {
          select: {
            categories: true
          }
        }
      }
    })

    if (!contest) {
      log.warn('Contest not found', { contestId: id })
      return res.status(404).json({ error: 'Contest not found' })
    }

    log.info('Contest retrieved successfully', { contestId: id, name: contest.name })
    res.json(contest)
  } catch (error) {
    log.error('Get contest error', { error: error.message, stack: error.stack, contestId: req.params.id })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const getContestsByEvent = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { eventId } = req.params
    log.debug('Fetching contests by event', { eventId })
    const where = { eventId }

    const contests = await prisma.contest.findMany({
      where,
      select: {
        id: true,
        eventId: true,
        name: true,
        description: true,
        createdAt: true,
        updatedAt: true,
        contestantNumberingMode: true,
        nextContestantNumber: true,
        event: true,
        _count: {
          select: {
            categories: true
          }
        }
        // Explicitly exclude archived field which doesn't exist in DB
      },
      orderBy: { createdAt: 'desc' }
    })

    log.info('Contests retrieved successfully', { eventId, count: contests.length })
    res.json(contests)
  } catch (error) {
    log.error('Get contests by event error', { error: error.message, stack: error.stack, eventId: req.params.eventId })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const createContest = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { eventId } = req.params
    const { name, description } = req.body
    log.info('Contest creation requested', { eventId, name, userId: req.user?.id })

    // Validate required fields
    if (!name) {
      log.warn('Contest creation failed: name is required', { eventId })
      return res.status(400).json({ error: 'Name is required' })
    }

    if (!eventId) {
      log.warn('Contest creation failed: eventId is required')
      return res.status(400).json({ error: 'EventId is required' })
    }

    log.debug('Creating contest record', { name, eventId })
    const contest = await prisma.contest.create({
      data: {
        name,
        description: description || null,
        eventId
      }
    })

    log.info('Contest created successfully', { contestId: contest.id, name: contest.name, eventId })
    res.status(201).json(contest)
  } catch (error) {
    log.error('Create contest error', { error: error.message, stack: error.stack, eventId: req.params.eventId, name: req.body.name })
    res.status(500).json({ error: 'Internal server error', details: error.message })
  }
}

const updateContest = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { id } = req.params
    const { name, description } = req.body
    log.info('Contest update requested', { contestId: id, name, userId: req.user?.id })

    // Validate required fields
    if (!name) {
      log.warn('Contest update failed: name is required', { contestId: id })
      return res.status(400).json({ error: 'Name is required' })
    }

    log.debug('Updating contest record', { contestId: id, name })
    const contest = await prisma.contest.update({
      where: { id },
      data: {
        name,
        description: description || null
      }
    })

    log.info('Contest updated successfully', { contestId: id, name: contest.name })
    res.json(contest)
  } catch (error) {
    log.error('Update contest error', { error: error.message, stack: error.stack, contestId: req.params.id })
    res.status(500).json({ error: 'Internal server error', details: error.message })
  }
}

const deleteContest = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { id } = req.params
    log.info('Contest deletion requested', { contestId: id, userId: req.user?.id })

    const contestToDelete = await prisma.contest.findUnique({
      where: { id },
      select: { id: true, name: true }
    })

    if (!contestToDelete) {
      log.warn('Contest deletion failed: contest not found', { contestId: id })
      return res.status(404).json({ error: 'Contest not found' })
    }

    log.debug('Deleting contest record', { contestId: id, name: contestToDelete.name })
    await prisma.contest.delete({
      where: { id }
    })

    log.info('Contest deleted successfully', { contestId: id, name: contestToDelete.name })
    res.status(204).send()
  } catch (error) {
    log.error('Delete contest error', { error: error.message, stack: error.stack, contestId: req.params.id })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const archiveContest = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { id } = req.params
    const { reason } = req.body
    log.info('Contest archive requested', { contestId: id, reason, userId: req.user?.id })

    const contest = await prisma.contest.findUnique({
      where: { id },
      include: {
        categories: {
          include: {
            _count: {
              select: {
                scores: true,
                contestants: true
              }
            }
          }
        }
      }
    })

    if (!contest) {
      log.warn('Contest archive failed: contest not found', { contestId: id })
      return res.status(404).json({ error: 'Contest not found' })
    }

    if (contest.archived) {
      log.warn('Contest archive failed: already archived', { contestId: id })
      return res.status(400).json({ error: 'Contest is already archived' })
    }

    log.debug('Archiving contest', { contestId: id })
    const updatedContest = await prisma.contest.update({
      where: { id },
      data: { archived: true }
    })

    log.info('Contest archived successfully', { contestId: id, name: updatedContest.name })
    res.json({
      message: 'Contest archived successfully',
      contest: updatedContest
    })
  } catch (error) {
    log.error('Archive contest error', { error: error.message, stack: error.stack, contestId: req.params.id })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const reactivateContest = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { id } = req.params
    log.info('Contest reactivation requested', { contestId: id, userId: req.user?.id })

    const contest = await prisma.contest.findUnique({
      where: { id }
    })

    if (!contest) {
      log.warn('Contest reactivation failed: contest not found', { contestId: id })
      return res.status(404).json({ error: 'Contest not found' })
    }

    if (!contest.archived) {
      log.warn('Contest reactivation failed: not archived', { contestId: id })
      return res.status(400).json({ error: 'Contest is not archived' })
    }

    log.debug('Reactivating contest', { contestId: id })
    const updatedContest = await prisma.contest.update({
      where: { id },
      data: { archived: false }
    })

    log.info('Contest reactivated successfully', { contestId: id, name: updatedContest.name })
    res.json({
      message: 'Contest reactivated successfully',
      contest: updatedContest
    })
  } catch (error) {
    log.error('Reactivate contest error', { error: error.message, stack: error.stack, contestId: req.params.id })
    res.status(500).json({ error: 'Internal server error' })
  }
}

const getArchivedContests = async (req, res) => {
  const log = createRequestLogger(req, 'contests')
  try {
    const { eventId } = req.query
    log.debug('Fetching archived contests', { eventId })

    const where = {
      archived: true,
      ...(eventId && { eventId })
    }

    const contests = await prisma.contest.findMany({
      where,
      include: {
        event: true,
        _count: {
          select: {
            categories: true
          }
        }
      },
      orderBy: { updatedAt: 'desc' }
    })

    log.info('Archived contests retrieved successfully', { count: contests.length, eventId })
    res.json(contests)
  } catch (error) {
    log.error('Get archived contests error', { error: error.message, stack: error.stack, eventId: req.query.eventId })
    res.status(500).json({ error: 'Internal server error' })
  }
}

module.exports = {
  getContestById,
  getContestsByEvent,
  createContest,
  updateContest,
  deleteContest,
  archiveContest,
  reactivateContest,
  getArchivedContests
}
